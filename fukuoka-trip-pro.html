<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="2026福岡" />
    <link rel="manifest" href="site.webmanifest" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 福岡</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Noto+Serif+TC:wght@700;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, update, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDMB5dU2aRAZ-mt9_HNXP02_9_B2qydfBg",
            authDomain: "fukuoka-trip-c2570.firebaseapp.com",
            databaseURL: "https://fukuoka-trip-c2570-default-rtdb.firebaseio.com",
            projectId: "fukuoka-trip-c2570",
            storageBucket: "fukuoka-trip-c2570.firebasestorage.app",
            messagingSenderId: "887170926378",
            appId: "1:887170926378:web:3e7c72bb374775c29e8053",
            measurementId: "G-HYDZ7L3T0Y"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        window.fb = { db, ref, onValue, update, set };
    </script>

    <style>
        :root { --bg-color: #f8f5e6; --accent: #c0392b; --kkday-blue: #00a1e4; --klook-orange: #ff5b00; }
        body { background-color: var(--bg-color); font-family: 'Noto Sans TC', sans-serif; color: #333; }
        .serif-font { font-family: 'Noto Serif TC', serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .date-active { color: var(--accent) !important; position: relative; }
        .date-active::after { content: ''; position: absolute; bottom: 0; left: 10%; width: 80%; height: 3px; background: var(--accent); }
        .card { background: #ffffff; border-radius: 1rem; box-shadow: 0 4px 10px rgba(0,0,0,0.01); overflow: hidden; }
        .edit-input { background: transparent; border: none; width: 100%; outline: none; }
        
        .time-col { width: 42px; min-width: 42px; flex-shrink: 0; border-right: 1px solid #f3f4f6; padding-right: 0.15rem; margin-right: 0.4rem; }
        .time-input { font-family: 'Noto Serif TC', serif; font-weight: 900; text-align: center; background: transparent; border: none; outline: none; width: 100%; font-size: 13px; letter-spacing: -0.5px; }
        
        .drag-handle { cursor: grab; color: #eee; padding-left: 10px; padding-right: 6px; display: flex; align-items: center; }
        .weather-now-bg { background: linear-gradient(135deg, #ffffff 0%, #f0f7ff 100%); }
        .weather-item { flex-shrink: 0; display: flex; flex-direction: column; align-items: center; min-width: 54px; }
        
        .action-btn { display: flex; align-items: center; justify-content: center; width: 100%; min-height: 28px; }
        .actions-group { 
            width: 34px; 
            min-width: 34px; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            flex-shrink: 0; 
            border-left: 1px solid #f9fafb;
            margin-left: 4px;
        }

        .special-link-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px;
            border-radius: 0.75rem;
            color: white;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: opacity 0.2s;
            margin-bottom: 1.5rem;
        }
        .special-link-btn:active { opacity: 0.8; }
        .bg-kkday { background-color: var(--kkday-blue); }
        .bg-klook { background-color: var(--klook-orange); }

        .text-fade-edge {
            mask-image: linear-gradient(to right, black 85%, transparent 100%);
            -webkit-mask-image: linear-gradient(to right, black 85%, transparent 100%);
        }

        @keyframes spin-once {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-once { animation: spin-once 0.6s ease-in-out; }
    </style>
</head>
<body class="antialiased pb-28">
    <div id="app" class="max-w-md mx-auto min-h-screen relative shadow-2xl">
        
        <header class="sticky top-0 z-50 bg-[#f8f5e6]/95 backdrop-blur-sm pt-8 pb-4 px-5">
            <div class="text-center mb-6 relative">
                <div class="text-[10px] text-gray-400 tracking-[0.3em] font-bold">2026</div>
                <h1 class="text-3xl font-black serif-font text-gray-800 tracking-tighter">福岡</h1>
            </div>
            <div v-show="activeTab === 'trip'" class="flex overflow-x-auto hide-scrollbar gap-6 py-2 border-b border-gray-200/50">
                <div v-for="(day, index) in itinerary" :key="index" @click="activeDayIndex = index"
                     :class="['flex-shrink-0 flex flex-col items-center cursor-pointer', activeDayIndex === index ? 'date-active' : 'text-gray-400']">
                    <span class="text-[9px] font-bold mb-1">{{day.week}}</span>
                    <span class="text-2xl font-serif font-black">{{day.date.split('-')[2]}}</span>
                </div>
            </div>
        </header>

        <main class="p-5">
            <!-- 分頁：行程 -->
            <div v-show="activeTab === 'trip'">
                <div class="card p-4 mb-6 weather-now-bg">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-[11px] font-black text-gray-700 tracking-widest uppercase">{{ weatherLabel }}</span>
                        <span class="text-[9px] text-gray-300 font-bold tracking-tighter">{{ displayDateLabel }}</span>
                    </div>
                    <div class="flex overflow-x-auto hide-scrollbar gap-4 py-2">
                        <template v-if="hourlyWeather.length > 0">
                            <div v-for="(h, i) in hourlyWeather" :key="i" class="weather-item">
                                <span class="text-[9px] font-bold text-gray-400 mb-2">{{ h.time }}</span>
                                <i :class="[getWeatherIcon(h.code), 'text-blue-400']" class="text-lg mb-2"></i>
                                <span class="font-black text-sm text-gray-800">{{ Math.round(h.temp) }}°</span>
                            </div>
                        </template>
                        <div v-else class="w-full text-center py-4 text-xs text-gray-300 italic">正在更新氣象數據...</div>
                    </div>
                </div>

                <div v-if="daySpecificLink" @click="openLink(daySpecificLink.url)" 
                     :class="['special-link-btn shadow-sm animate-in fade-in slide-in-from-top-2 duration-300', daySpecificLink.type === 'kkday' ? 'bg-kkday' : 'bg-klook']">
                    <i :class="daySpecificLink.type === 'kkday' ? 'fas fa-ticket-simple' : 'fas fa-location-dot'"></i>
                    <span>{{ daySpecificLink.label }}</span>
                    <i class="fas fa-arrow-up-right-from-square text-[10px] opacity-70"></i>
                </div>

                <div id="event-list" class="space-y-4">
                    <template v-for="(event, eIndex) in currentEvents" :key="eIndex">
                        <div class="card flex flex-col">
                            <div class="flex items-center p-3 pr-1 min-h-[72px]">
                                <div class="drag-handle"><i class="fas fa-grip-lines-vertical text-[10px]"></i></div>
                                <div class="time-col"><input v-model="event.time" @change="syncData" class="time-input"></div>
                                <div class="flex-grow overflow-hidden text-fade-edge">
                                    <input v-model="event.location" @change="syncData" class="edit-input font-bold text-sm text-gray-800 truncate block w-full" placeholder="地點名稱">
                                    <input v-model="event.desc" @change="syncData" class="edit-input text-[11px] text-gray-400 truncate block w-full" placeholder="備註內容">
                                </div>
                                <div class="actions-group">
                                    <button @click="openMaps(event.location)" class="action-btn text-blue-400/40 active:text-blue-600"><i class="fas fa-location-dot text-xs"></i></button>
                                    <button @click="removeEvent(eIndex)" class="action-btn text-gray-200 active:text-red-500"><i class="fas fa-trash-can text-[10px]"></i></button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
                <button @click="addEvent" class="w-full py-4 mt-6 text-[11px] font-bold text-gray-300 border border-dashed border-gray-200 rounded-2xl">+ 新增項目</button>
            </div>

            <!-- 分頁：匯率工具 -->
            <div v-show="activeTab === 'fx'">
                <div class="card p-8 text-center space-y-12 relative">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-2xl font-serif font-bold text-gray-800">匯率換算</h2>
                        <button @click="fetchLatestRate" class="p-2 text-gray-300 hover:text-[#c0392b] transition-all" :class="{'animate-spin-once': isRefreshingFX}">
                            <i class="fas fa-arrows-rotate"></i>
                        </button>
                    </div>
                    
                    <div class="relative">
                        <label class="text-[10px] text-gray-300 font-bold block text-left mb-1 uppercase tracking-widest">日幣金額 (JPY)</label>
                        <input type="number" v-model="jpy" @input="convertFX('jpy')" class="font-serif text-5xl w-full text-center outline-none bg-transparent border-b-2 border-gray-50 focus:border-red-100 transition-colors" placeholder="0">
                    </div>
                    
                    <div class="text-[#c0392b] opacity-20"><i class="fas fa-sync rotate-90 text-2xl"></i></div>
                    
                    <div class="relative">
                        <label class="text-[10px] text-gray-300 font-bold block text-left mb-1 uppercase tracking-widest">台幣金額 (TWD)</label>
                        <input type="number" v-model="twd" @input="convertFX('twd')" class="font-serif text-5xl w-full text-center outline-none bg-transparent border-b-2 border-gray-50 focus:border-red-100 transition-colors" placeholder="0">
                    </div>

                    <div class="text-[11px] text-gray-400 italic">
                        目前參考匯率：1 JPY ≈ {{ rate.toFixed(4) }} TWD
                    </div>
                </div>
            </div>

            <!-- 分頁：口袋名單 (其他) -->
            <div v-show="activeTab === 'others'">
                <div class="space-y-4">
                    <div v-for="(item, oIndex) in otherList" :key="oIndex" class="card flex flex-col">
                        <div class="flex items-center p-3 pr-1 min-h-[72px]">
                            <div class="drag-handle"><i class="fas fa-grip-lines-vertical text-[10px]"></i></div>
                            <div class="flex-grow ml-3 overflow-hidden text-fade-edge">
                                <input v-model="item.name" @change="syncData" class="edit-input font-black text-base text-gray-800 truncate block w-full" placeholder="名稱">
                                <input v-model="item.note" @change="syncData" class="edit-input text-xs text-gray-400 truncate block w-full" placeholder="備註內容">
                            </div>
                            <div class="actions-group">
                                <button @click="openMaps(item.name)" class="action-btn text-blue-400/40 active:text-blue-600"><i class="fas fa-location-dot text-xs"></i></button>
                                <button @click="removeOther(oIndex)" class="action-btn text-gray-200 active:text-red-500"><i class="fas fa-trash-can text-[10px]"></i></button>
                            </div>
                        </div>
                    </div>
                    <button @click="addOther" class="w-full py-4 text-gray-300 border border-dashed border-gray-200 rounded-2xl text-[11px] font-bold">+ 新增名單</button>
                </div>
            </div>
        </main>

        <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] h-16 bg-white/90 backdrop-blur-sm shadow-2xl rounded-full flex justify-around items-center px-4 z-50">
            <button @click="activeTab = 'trip'" :class="['flex flex-col items-center w-1/3 transition-colors', activeTab === 'trip' ? 'text-[#c0392b]' : 'text-gray-300']">
                <i class="fas fa-calendar-day text-lg"></i>
                <span class="text-[9px] font-bold mt-1">行程</span>
            </button>
            <button @click="activeTab = 'others'" :class="['flex flex-col items-center w-1/3 transition-colors', activeTab === 'others' ? 'text-[#c0392b]' : 'text-gray-300']">
                <i class="fas fa-utensils text-lg"></i>
                <span class="text-[9px] font-bold mt-1">其他</span>
            </button>
            <button @click="activeTab = 'fx'" :class="['flex flex-col items-center w-1/3 transition-colors', activeTab === 'fx' ? 'text-[#c0392b]' : 'text-gray-300']">
                <i class="fas fa-calculator text-lg"></i>
                <span class="text-[9px] font-bold mt-1">匯率</span>
            </button>
        </nav>
    </div>

    <script>
        const { createApp, ref, onMounted, watch, computed } = Vue;
        createApp({
            setup() {
                const activeTab = ref('trip');
                const activeDayIndex = ref(0);
                const itinerary = ref([]);
                const otherList = ref([]);
                const jpy = ref(0);
                const twd = ref(0);
                const rate = ref(0.215); 
                const isRefreshingFX = ref(false);
                const weatherData = ref({ time: [], temperature_2m: [], weathercode: [] });
                const currentWeatherData = ref(null);
                const hourlyWeather = ref([]);

                const currentEvents = computed(() => itinerary.value[activeDayIndex.value]?.events || []);
                const selectedDateString = computed(() => itinerary.value[activeDayIndex.value]?.date || "");
                const isFutureDate = computed(() => {
                    if (!selectedDateString.value) return false;
                    const target = new Date(selectedDateString.value);
                    const now = new Date();
                    return target.getTime() > (now.getTime() + 14 * 24 * 60 * 60 * 1000);
                });

                const weatherLabel = computed(() => {
                    const firstLoc = currentEvents.value[0]?.location || "福岡市";
                    return isFutureDate.value ? `福岡市 · 即時天氣` : `${firstLoc} · 今日預報`;
                });

                const displayDateLabel = computed(() => isFutureDate.value ? "目前狀態" : selectedDateString.value);

                const daySpecificLink = computed(() => {
                    const dateStr = selectedDateString.value;
                    if (!dateStr) return null;
                    const day = `${parseInt(dateStr.split('-')[1])}/${parseInt(dateStr.split('-')[2])}`;
                    if (day === "3/5") return { type: 'kkday', label: 'KKday 阿蘇高千穗一日遊', url: 'https://www.kkday.com/zh-tw/product/266452-mount-aso-kusasenri-takachiho-gorge-cruise-kyushu-one-day-tour?qs=%E9%AB%98%E5%8D%83' };
                    if (day === "3/7") return { type: 'kkday', label: '九州大分由布院動物園一日遊', url: 'https://www.kkday.com/zh-tw/product/175897' };
                    if (day === "3/9") return { type: 'klook', label: 'Klook 糸島一日遊行程', url: 'https://www.klook.com/zh-TW/activity/114628-shiraito-falls-keya-no-ohto-sakurai-futamigauras-couple-stones-day-trip/?spm=SearchResult.SearchResult_LIST&clickId=dbcf008b29' };
                    return null;
                });

                const initFirebase = () => {
                    if (!window.fb) return setTimeout(initFirebase, 500);
                    window.fb.onValue(window.fb.ref(window.fb.db, '/'), (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            itinerary.value = data.itinerary || [];
                            otherList.value = data.otherList || [];
                            if (data.sharedFX) { 
                                jpy.value = data.sharedFX.jpy ?? 0; 
                                twd.value = data.sharedFX.twd ?? 0; 
                            }
                            if (data.currentRate) { rate.value = data.currentRate; }
                        }
                    });
                };

                const syncData = () => {
                    window.fb.update(window.fb.ref(window.fb.db, '/'), {
                        itinerary: JSON.parse(JSON.stringify(itinerary.value)),
                        otherList: JSON.parse(JSON.stringify(otherList.value))
                    });
                };

                const fetchWeather = async () => {
                    try {
                        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=33.59&longitude=130.40&hourly=temperature_2m,weathercode&current_weather=true&timezone=Asia%2FTokyo&forecast_days=14`);
                        const data = await res.json();
                        weatherData.value = data.hourly;
                        currentWeatherData.value = data.current_weather;
                        updateHourly();
                    } catch(e) { console.error("Weather Error:", e); }
                };

                const updateHourly = () => {
                    const targetDate = selectedDateString.value;
                    if (!targetDate) return;
                    if (isFutureDate.value && currentWeatherData.value) {
                        const now = new Date();
                        const currentHour = now.getHours();
                        const display = [];
                        for(let i=0; i<6; i++) {
                            const h = (currentHour + i * 4) % 24;
                            display.push({ time: `${h}:00`, temp: currentWeatherData.value.temperature, code: currentWeatherData.value.weathercode });
                        }
                        hourlyWeather.value = display;
                    } else if (weatherData.value.time) {
                        const filtered = [];
                        weatherData.value.time.forEach((timeStr, idx) => {
                            if (timeStr.startsWith(targetDate)) {
                                const hourStr = timeStr.split('T')[1].substring(0, 5);
                                if (parseInt(hourStr.split(':')[0]) % 4 === 0) {
                                    filtered.push({ time: hourStr, temp: weatherData.value.temperature_2m[idx], code: weatherData.value.weathercode[idx] });
                                }
                            }
                        });
                        hourlyWeather.value = filtered;
                    }
                };

                // 修復匯率抓取失敗的問題：改用較穩定的 API 並加入備援
                const fetchLatestRate = async () => {
                    isRefreshingFX.value = true;
                    try {
                        // 使用 exchangerate-api.com 的穩定公開端點
                        const res = await fetch(`https://open.er-api.com/v6/latest/JPY`);
                        if (!res.ok) throw new Error('Network response was not ok');
                        const data = await res.json();
                        if (data && data.rates && data.rates.TWD) {
                            // 獲取匯率並同步
                            rate.value = data.rates.TWD;
                            window.fb.update(window.fb.ref(window.fb.db, '/'), { currentRate: rate.value });
                            if (jpy.value) convertFX('jpy');
                        }
                    } catch (e) { 
                        console.error("FX Fetch Error (CORS or Network):", e);
                        // 如果失敗，嘗試使用本地存儲或預設值，不中斷程序
                    } finally {
                        setTimeout(() => isRefreshingFX.value = false, 600);
                    }
                };

                const convertFX = (type) => {
                    if (type === 'jpy') twd.value = Math.round((jpy.value || 0) * rate.value);
                    else jpy.value = Math.round((twd.value || 0) / rate.value);
                    
                    const safeJPY = jpy.value || 0;
                    const safeTWD = twd.value || 0;
                    window.fb.update(window.fb.ref(window.fb.db, 'sharedFX'), { jpy: safeJPY, twd: safeTWD });
                };

                const getWeatherIcon = (c) => {
                    if (c <= 1) return 'fas fa-sun';
                    if (c <= 3) return 'fas fa-cloud-sun';
                    if (c >= 61) return 'fas fa-cloud-rain';
                    return 'fas fa-cloud';
                };

                const openMaps = (loc) => window.open(`https://www.google.com/maps/search/${encodeURIComponent(loc)}`, '_blank');
                const openLink = (url) => window.open(url, '_blank');
                const addEvent = () => { currentEvents.value.push({ time: "12:00", location: "", desc: "" }); syncData(); };
                const removeEvent = (i) => { if(confirm("確定刪除此行程項目？")) { currentEvents.value.splice(i, 1); syncData(); } };
                const addOther = () => { otherList.value.push({ name: "", note: "" }); syncData(); };
                const removeOther = (i) => { if(confirm("確定刪除此口袋名單？")) { otherList.value.splice(i, 1); syncData(); } };

                onMounted(() => { initFirebase(); fetchWeather(); fetchLatestRate(); });
                watch([activeDayIndex, weatherData], updateHourly);

                return { 
                    activeTab, activeDayIndex, itinerary, otherList, jpy, twd, rate, isRefreshingFX,
                    hourlyWeather, weatherLabel, displayDateLabel, currentEvents, 
                    daySpecificLink, syncData, openMaps, openLink, addEvent, removeEvent, 
                    addOther, removeOther, getWeatherIcon, convertFX, fetchLatestRate 
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
